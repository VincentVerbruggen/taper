# Milestone 2b: Substance Management Enhancements

## Context
The Log form currently has no default substance — users must pick from the dropdown every time. There's also no way to hide substances you've stopped tracking without deleting them (and losing dose history). This milestone adds two boolean flags to substances: `isMain` (pre-selects in the Log form) and `isVisible` (hides from dropdowns without deleting data).

## Files to Modify

| File | What |
|------|------|
| `lib/data/database.dart` | Add columns, bump schema, migration, new query methods |
| `lib/data/database.g.dart` | Regenerated by build_runner (not manual) |
| `lib/providers/database_providers.dart` | Add `visibleSubstancesProvider` |
| `lib/screens/substances/substances_screen.dart` | Star + eye icons on each substance |
| `lib/screens/log/log_dose_screen.dart` | Filter to visible substances, auto-select main |
| `test/log_dose_screen_test.dart` | Update/add tests for new behavior |

## Implementation Steps

### Step 0: Copy plan to repo
Copy this plan from `~/.claude/plans/` into `plans/milestone-2b.md` in the repo so it's tracked alongside the project.

### Step 1: Add columns to Substances table
In `database.dart` lines 9-12, add two `BoolColumn` definitions:

```dart
class Substances extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text()();
  BoolColumn get isMain => boolean().withDefault(const Constant(false))();
  BoolColumn get isVisible => boolean().withDefault(const Constant(true))();
}
```

`withDefault` makes both columns optional in `SubstancesCompanion.insert()` — existing `insertSubstance(name)` calls keep working. Like `$table->boolean('is_main')->default(false)` in a Laravel migration.

### Step 2: Database migration v2 → v3
Bump `schemaVersion` to 3 (line 52). Add migration block using Drift's `m.addColumn()` — it generates `ALTER TABLE substances ADD COLUMN is_main INTEGER NOT NULL DEFAULT 0`. Update the seeder to seed three substances on fresh install — gives us visible/hidden/main states to test with:

```dart
schemaVersion => 3;

onCreate: (m) async {
  await m.createAll();
  // Caffeine: main + visible (the default substance in the Log form)
  await into(substances).insert(
    SubstancesCompanion.insert(name: 'Caffeine', isMain: const Value(true)),
  );
  // Water: visible but not main (a second option in the dropdown)
  await into(substances).insert(
    SubstancesCompanion.insert(name: 'Water'),
  );
  // Alcohol: hidden (won't appear in Log dropdown, but data preserved)
  await into(substances).insert(
    SubstancesCompanion.insert(name: 'Alcohol', isVisible: const Value(false)),
  );
},
onUpgrade: (m, from, to) async {
  if (from < 2) { await m.createTable(doseLogs); }
  if (from < 3) {
    await m.addColumn(substances, substances.isMain);
    await m.addColumn(substances, substances.isVisible);
    // Seed Water and Alcohol for existing installs too, so they have
    // something to see the visibility difference with.
    await into(substances).insert(
      SubstancesCompanion.insert(name: 'Water'),
    );
    await into(substances).insert(
      SubstancesCompanion.insert(name: 'Alcohol', isVisible: const Value(false)),
    );
  }
},
```

### Step 3: New database methods
Add three methods to `AppDatabase`:

1. **`watchVisibleSubstances()`** — `Stream<List<Substance>>` filtered to `isVisible == true`, sorted by name. Used by Log form dropdown.

2. **`setMainSubstance(int id)`** — Transaction: unset all `isMain` flags, then set the target. Ensures only one main at a time. Like `DB::transaction(fn() => ...)`.

3. **`toggleSubstanceVisibility(int id, bool isVisible)`** — Sets `isVisible` on one substance. When hiding (`isVisible = false`), also clears `isMain` — a hidden substance can't be the default in the Log form.

### Step 4: Add `visibleSubstancesProvider`
In `database_providers.dart`, add a new `StreamProvider` that calls `watchVisibleSubstances()`. The existing `substancesProvider` stays (used by Substances screen to show ALL substances including hidden).

```dart
final visibleSubstancesProvider = StreamProvider<List<Substance>>((ref) {
  final db = ref.watch(databaseProvider);
  return db.watchVisibleSubstances();
});
```

### Step 5: Run code generation
`dart run build_runner build --delete-conflicting-outputs` — regenerates `database.g.dart` with `isMain`/`isVisible` on the `Substance` data class and companion.

### Step 6: Substances screen — star + eye icons
Update `_SubstanceListItem` to show:
- **Leading:** Star icon (filled/outlined) — tap to set as main. Disabled when substance is hidden (can't make a hidden substance the default).
- **Trailing:** Eye icon (open/closed) + existing delete icon in a `Row`. Tap eye to toggle visibility.
- **Title:** Strikethrough + dimmed text when hidden — visual cue it won't appear in Log form.

Add handler methods in `_SubstancesScreenState`:
- `_setMainSubstance(id)` → calls `db.setMainSubstance(id)`
- `_toggleVisibility(id, currentlyVisible)` → calls `db.toggleSubstanceVisibility(id, !currentlyVisible)`

### Step 7: Log dose screen — filter + auto-select
Two changes in `log_dose_screen.dart`:

1. **Switch provider:** Change `ref.watch(substancesProvider)` (line 63) to `ref.watch(visibleSubstancesProvider)`. Hidden substances disappear from the dropdown.

2. **Auto-select main:** In `_buildForm()`, if `_selectedSubstance` is null, find the main substance and schedule a `setState` via `addPostFrameCallback`. Switch the dropdown from `initialValue` to `value` (so it updates reactively). Look up the matching instance by ID from the current substances list (needed because Drift's `==` compares all fields — the stream might return new instances).

```dart
// Auto-select main substance on first load
if (_selectedSubstance == null) {
  final main = substances.where((s) => s.isMain).firstOrNull;
  if (main != null) {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && _selectedSubstance == null) {
        setState(() => _selectedSubstance = main);
      }
    });
  }
}
```

**Edit dose screen:** No changes. It already uses `substancesProvider` (all substances) and pre-fills from the existing entry. Keeping all substances available in edit mode is intentional — the user should see the original substance even if it was hidden after logging.

**Recent logs list:** No changes. `doseLogsProvider` returns all logs regardless of visibility. Historical logs for hidden substances should remain visible.

### Step 8: Update tests
The seeder now inserts 3 substances (Caffeine as main, Water as visible, Alcohol as hidden), so tests that reference seeded data may need updates (e.g., substance counts, dropdown item counts).

Existing tests should mostly pass because:
- Caffeine is seeded with `isMain: true` and `isVisible: true` (default), so it still appears in dropdowns
- The "save button disabled" test still passes — Caffeine auto-selects, but no amount is entered
- The "can log a dose" test still passes — it explicitly selects Caffeine, which is already selected

New tests to add:
- Hidden substance (Alcohol) doesn't appear in the Log dropdown
- Visible substances (Caffeine, Water) do appear
- Main substance (Caffeine) is auto-selected in the dropdown
- Save works with auto-selected main (no explicit dropdown pick needed)

Existing tests may need minor tweaks:
- `initialValue` → `value` change on the dropdown
- Tests that expect only "Caffeine" in the dropdown now also have "Water"

## Verification
```bash
dart run build_runner build --delete-conflicting-outputs
flutter analyze
flutter test
flutter run
```

On device:
- Substances screen: 3 seeded substances with star + eye icons
- Caffeine: filled star (main), open eye (visible)
- Water: empty star, open eye (visible)
- Alcohol: star disabled, closed eye (hidden), strikethrough name
- Tap star on Water → Water becomes main, Caffeine's star empties
- Tap eye on Caffeine → Caffeine hidden (strikethrough, star disabled, main cleared)
- Log screen: dropdown only shows Caffeine + Water (not Alcohol)
- Log screen: Caffeine pre-selected as main
- Log screen: recent logs still show doses from hidden substances
- Edit screen: dropdown shows ALL substances including Alcohol
- Fresh install: all 3 substances seeded correctly
