# Taper â€” Trackable Tracker Roadmap

## What We're Building

A trackable tracker app. You add trackables (like caffeine, alcohol), log doses (e.g., 90mg coffee, 330ml beer), and see a **pharmacokinetic decay curve** showing how much is still active in your system throughout the day.

## Architecture

**Flutter + Riverpod + Drift** â€” a reactive architecture where the database emits streams, providers transform them, and widgets rebuild automatically.

| Layer | Flutter | Laravel equivalent |
|-------|---------|-------------------|
| UI (Widgets) | `StatelessWidget` / `ConsumerWidget` | Blade templates / Vue components |
| State Management | Riverpod `StreamProvider` / `FutureProvider` | Controller (reactive, like Inertia props) |
| Database | Drift tables + query methods on `AppDatabase` | Eloquent models + query scopes |
| Models | Drift-generated `DataClass` (e.g., `Trackable`) | Eloquent Model attributes |
| DI | Riverpod `Provider` (auto-scoped) | `AppServiceProvider` bindings |

No separate repository or DAO layer â€” Drift query methods live directly on `AppDatabase`, and Riverpod providers wrap them. Simpler than the old Kotlin MVVM setup.

## Project Structure

```
lib/
â”œâ”€â”€ main.dart                              # App entry point, ProviderScope, MaterialApp
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ database.dart                      # Drift tables, AppDatabase, all query methods
â”‚   â”œâ”€â”€ database.g.dart                    # Generated by build_runner (never edit manually)
â”‚   â””â”€â”€ decay_model.dart                   # DecayModel enum (none/exponential/linear)
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ database_providers.dart            # Riverpod providers wrapping database streams
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ day_boundary.dart                  # 5 AM day boundary utilities
â”‚   â””â”€â”€ decay_calculator.dart              # Pharmacokinetic decay math (exponential + linear)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ notification_service.dart          # Persistent notification for rapid dose tracking
â””â”€â”€ screens/
    â”œâ”€â”€ home_screen.dart                   # Bottom nav scaffold (Dashboard / Log / Trackables)
    â”œâ”€â”€ dashboard_screen.dart              # Dashboard tab (trackable cards + decay curves)
    â”œâ”€â”€ dashboard/
    â”‚   â”œâ”€â”€ trackable_log_screen.dart      # Per-trackable dose history (infinite scroll)
    â”‚   â””â”€â”€ widgets/
    â”‚       â”œâ”€â”€ trackable_card.dart        # Card: stats + chart + toolbar
    â”‚       â””â”€â”€ decay_curve_chart.dart     # Mini fl_chart LineChart
    â”œâ”€â”€ log/
    â”‚   â”œâ”€â”€ log_dose_screen.dart           # Recent doses list + FAB to add
    â”‚   â”œâ”€â”€ add_dose_screen.dart           # Full form: trackable picker, amount, time
    â”‚   â”œâ”€â”€ edit_dose_screen.dart          # Edit existing dose log
    â”‚   â””â”€â”€ widgets/
    â”‚       â””â”€â”€ time_picker.dart           # Reusable time picker widget
    â”œâ”€â”€ shared/
    â”‚   â””â”€â”€ quick_add_dose_dialog.dart     # Quick-add dialog (from dashboard cards)
    â””â”€â”€ trackables/
        â”œâ”€â”€ trackables_screen.dart         # Trackable list with reorder, pin
        â”œâ”€â”€ add_trackable_screen.dart      # Full form: name, unit, decay model, params
        â””â”€â”€ edit_trackable_screen.dart     # Edit form + visibility toggle + delete
```

## Dependencies

| Package | Purpose |
|---------|---------|
| flutter_riverpod | State management (like a reactive service container) |
| drift + drift_flutter | Type-safe SQLite ORM (like Eloquent, with code generation) |
| fl_chart | Charting library for decay curves |
| path_provider + path | Locating the SQLite database file on disk |
| flutter_local_notifications | Persistent notification for rapid dose tracking |

Dev: `drift_dev` + `build_runner` for code generation.

## Data Models (schema v14)

### Trackable
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `name` | `String` | e.g., "Caffeine", "Alcohol" |
| `halfLifeHours` | `double?` | Nullable. For exponential decay (e.g., 5.0 for caffeine) |
| `unit` | `String` | e.g., "mg", "ml", "g", "IU" â€” displayed in all amount fields |
| `isMain` | `bool` | Legacy, no longer used (kept for migration compat) |
| `isVisible` | `bool` | Default `true`. Hidden trackables don't appear in dropdowns/dashboard |
| `color` | `int` | ARGB color value. Auto-assigned from palette, cycles through 10 colors |
| `sortOrder` | `int` | For drag-to-reorder in the trackables list |
| `decayModel` | `String` | `'none'`, `'exponential'`, or `'linear'` |
| `eliminationRate` | `double?` | Nullable. Units-per-hour for linear decay (e.g., 9.0 ml/h for alcohol) |
| `absorptionMinutes`| `double?` | Ramp-up time before decay begins |

### DoseLog
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `trackableId` | `int` | FK â†’ trackables (cascade delete) |
| `amount` | `double` | Raw amount in the trackable's unit |
| `loggedAt` | `DateTime` | When the dose was consumed |
| `name` | `String?` | Optional preset name (e.g., "Espresso") |

## Decay Models

### Exponential (half-life)
```
active_amount(t) = Î£ dose Ã— 0.5^(hours_elapsed / half_life)
```
Used for trackables like caffeine. Cutoff at 10 half-lives (< 0.1% remaining). Sampling every 5 minutes for graphing.

### Linear (constant-rate elimination)
```
active_amount(t) = max(0, dose - elimination_rate Ã— hours_elapsed)
```
Used for trackables like alcohol where the liver processes at a constant rate (zero-order kinetics). Query window: 24 hours.

### None
No decay tracking. Used for trackables like water where you just want to track intake totals.

## Day Boundary

**"Today" starts at 5:00 AM**, not midnight. This lets late-night doses (e.g., alcohol at 1am) count as the previous day. Implemented as a **shared utility function** used everywhere. The 5am default is a user setting.

---

## Implementation Milestones

### Milestone 1 â€“ 12 âœ…
*Milestones 1 through 12 are completed, including: Trackable CRUD, Dose Logging, Dashboard, Decay Curves, Polish, Performance (Zero Background Work), Taper Plans, Customizable Dashboard, Reminders, and Data Export.*

### Milestone 13: UI Polish & Cleanup â† NEXT

Quick fixes and cleanups from real-world use. Small individual changes that collectively make the app feel tighter.

#### Dashboard
- [x] **Add "Dashboard" title** â€” heading in normal mode matches other tabs.
- [ ] **Dashboard title in edit mode** â€” the "Dashboard" heading should appear in edit mode too, not just the check/done button. Currently edit mode only shows the done icon at the top right.
- [ ] **Fix back navigation** â€” investigate `PopScope` to handle back differently when in dashboard edit mode.
- [x] **Remove colored left border** â€” the 4px left accent line on dashboard cards.
- [x] **Three-dot overflow menu** â€” added to dashboard card title row (Repeat Last, Add Dose, View Log, Progress).

#### Settings / Trackables
- [ ] **Remove drag-to-reorder from trackables** â€” Replace `ReorderableListView` with a plain `ListView` in Settings.
- [ ] **Add "Appearance" section header** â€” group the "Day starts at" and "Theme" settings.
- [x] **Remove subtitle from trackable list items** â€” list items now show just the name.
- [x] **Remove three-dots menu** â€” tapping a trackable opens the edit screen directly.

### Milestone 14: Biological Context & Behavioral Insights

Add "smarts" to the tracking by accounting for metabolism and user behavior.

#### Metabolism Presets (Variable Half-Life)
- **Biological Overrides** â€” Add toggles in the "Edit Trackable" screen for factors that significantly affect half-life.
  - `[ ] Smoker (-50% half-life)`
  - `[ ] Hormonal Contraceptives (+100% half-life)`
- **Formula Integration** â€” The `DecayCalculator` applies these modifiers to the base half-life before calculating active amounts.

#### Contextual Tags ("Why?" chips)
- **Low-Friction Feedback** â€” Add a horizontal scroll of chips to the Add Dose screen (Quick Add and Full Form).
- **Preset Chips** â€” ðŸ¥± `Tired`, ðŸ¤• `Headache`, ðŸ‘” `Work`, ðŸ» `Social`, ðŸ“‰ `Routine`.
- **Data Column** â€” Add a `tags` column (comma-separated string or new table) to `DoseLogs`.
- **Correlation Insight** â€” In the Taper Progress screen, show correlations (e.g., "75% of your over-budget doses were tagged 'Headache'").

#### Sleep Readiness Predictor
- **Sleep Threshold** â€” Add a "Sleep Readiness Threshold" field to trackables (e.g., 50mg for caffeine).
- **Readiness Widget** â€” A dashboard widget showing: *"You will reach your sleep threshold (50mg) in **3h 20m** (at 11:15 PM)."*

#### Taper Maintenance Mode
- **Hold Current Level** â€” A "Hold" button on the Taper progress card.
- **Slope Pause** â€” Temporarily pauses the daily reduction. It keeps the `targetAmount` at today's level but pushes the `endDate` of the plan out by one day for every day it's on hold.

### Milestone 15: Unified Decay Card & Chart Overhaul

Major chart rework. The goal: one card type, two viewing modes, richer data visualization.

- **Merge Enhanced into Standard** â€” The enhanced card (pan/zoom, gradient) becomes the only decay card.
- **Dual-Mode Chart** â€” Toggle between **Decay Focus** (active curve) and **Total Focus** (daily intake staircase).
- **Multi-Day View** â€” Extend chart window to show ~4 hours of previous day carry-over and next day bleed-over.
- **Acute Amount Thresholds** â€” Add a new threshold type that compares against **active amount** (e.g., "alert me if active caffeine > 200mg").

### Milestone 16: Daily Totals & Taper Integration

- **Show taper target line** on daily totals chart (stepped line following the schedule).
- **Extend to end of plan** â€” scroll forward to see the full plan duration.
- **Adherence Color Coding** â€” tint bars green (under target) or red (over target).

### Milestone 17: User Experience & Onboarding

Consolidate all "first-time user" and convenience features here.

- **Startup Wizard** â€” Multi-step welcome flow (Welcome â†’ Pick Trackables â†’ Analytics Opt-in).
- **Pick Trackables Grid** â€” Selection of common trackables with pre-filled settings (Caffeine, Alcohol, Water, Nicotine, Ibuprofen).
- **Analytics & Crash Reporting** â€” Opt-in Sentry/Firebase for anonymous usage stats and crash reports.
- **Empty State Hints** â€” Helpful graphics and text when no trackables or doses exist.
- **Quick-add Presets** (from Parked) â€” Rows of most common dose amounts on dashboard cards.

---

## Parked Ideas

- **Multi-trackable combined chart.**
- **Home screen widget.**
- **Interaction warnings.**
- **Planned consumption days** (Copy today's log as tomorrow's plan).
- **Trackable types (far future)** (Count, Yes/No, Amount types).
