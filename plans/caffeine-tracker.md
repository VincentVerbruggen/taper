# Taper — Substance Tracker Roadmap

## What We're Building

A substance tracker app. You add substances (like caffeine, alcohol), log doses (e.g., 90mg coffee, 330ml beer), and see a **pharmacokinetic decay curve** showing how much is still active in your system throughout the day.

## Architecture

**Flutter + Riverpod + Drift** — a reactive architecture where the database emits streams, providers transform them, and widgets rebuild automatically.

| Layer | Flutter | Laravel equivalent |
|-------|---------|-------------------|
| UI (Widgets) | `StatelessWidget` / `ConsumerWidget` | Blade templates / Vue components |
| State Management | Riverpod `StreamProvider` / `FutureProvider` | Controller (reactive, like Inertia props) |
| Database | Drift tables + query methods on `AppDatabase` | Eloquent models + query scopes |
| Models | Drift-generated `DataClass` (e.g., `Substance`) | Eloquent Model attributes |
| DI | Riverpod `Provider` (auto-scoped) | `AppServiceProvider` bindings |

No separate repository or DAO layer — Drift query methods live directly on `AppDatabase`, and Riverpod providers wrap them. Simpler than the old Kotlin MVVM setup.

## Project Structure

```
lib/
├── main.dart                              # App entry point, ProviderScope, MaterialApp
├── data/
│   ├── database.dart                      # Drift tables, AppDatabase, all query methods
│   └── database.g.dart                    # Generated by build_runner (never edit manually)
├── providers/
│   └── database_providers.dart            # Riverpod providers wrapping database streams
└── screens/
    ├── home_screen.dart                   # Bottom nav scaffold (Dashboard / Log / Substances)
    ├── dashboard_screen.dart              # Dashboard tab (substance cards + decay curves)
    ├── log/
    │   ├── log_dose_screen.dart           # Log form: substance picker, amount, time
    │   ├── edit_dose_screen.dart          # Edit existing dose log
    │   └── widgets/
    │       └── time_picker.dart           # Reusable time picker widget
    └── substances/
        └── substances_screen.dart         # Substance CRUD, main/visibility toggles
```

## Dependencies

| Package | Purpose |
|---------|---------|
| flutter_riverpod | State management (like a reactive service container) |
| drift + drift_flutter | Type-safe SQLite ORM (like Eloquent, with code generation) |
| fl_chart | Charting library for decay curves |
| path_provider + path | Locating the SQLite database file on disk |

Dev: `drift_dev` + `build_runner` for code generation.

## Data Models

### Substance
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `name` | `String` | e.g., "Caffeine", "Alcohol" |
| `halfLifeHours` | `double` | e.g., 5.0 for caffeine (needed for decay) |
| `unit` | `String` | e.g., "mg", "ml", "g", "IU" — displayed in all amount fields |
| `isMain` | `bool` | Default `false`. Only one substance can be main (pre-selects in Log form) |
| `isVisible` | `bool` | Default `true`. Hidden substances keep history but don't appear in dropdowns |
| `color` | `int` | ARGB color value. Auto-assigned from a palette on creation, user can change it. Used for chart lines and card accents. |

### DoseLog
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `substanceId` | `int` | FK → substances (cascade delete) |
| `amount` | `double` | Raw amount in the substance's unit |
| `loggedAt` | `DateTime` | When the dose was consumed |

## Decay Curve Formula

```
active_amount(t) = Σ dose × 0.5^(hours_elapsed / half_life)
```

- **Cutoff:** Only consider doses within the last **5 half-lives**. After 5 half-lives, only ~3% of the original dose remains — standard pharmacokinetic practice. This bounds the query window (e.g., caffeine with 5h half-life → only fetch doses from the last 25 hours).
- **Sampling:** Every 5 minutes from day boundary to day boundary for graphing.
- Example: Caffeine half-life = 5h → 90mg at 8am → ~45mg at 1pm → ~22mg at 6pm.

## Day Boundary

**"Today" starts at 5:00 AM**, not midnight. This lets late-night doses (e.g., alcohol at 1am) count as the previous day. Implemented as a **shared utility function** used everywhere: dashboard stats, mini graphs, substance log day grouping, notification stats.

The 5am default becomes a user setting in a later milestone.

## Deletion UX

No swipe-to-delete anywhere. All delete actions use a **delete button with a confirmation dialog** ("Are you sure you want to delete this dose?"). Applies to dose logs and substances alike.

---

## Implementation Milestones

### Milestone 1: Substance CRUD ✅
- Drift tables + dependencies
- Substance table + AppDatabase + seeder (inserts "Caffeine" on first run)
- Riverpod providers for substance streams
- Bottom nav scaffold (Dashboard / Log / Substances tabs)
- Substances screen with full CRUD (add, edit, delete with confirmation)

### Milestone 2: Dose Logging ✅
- DoseLog table + query methods
- Log dose screen with substance picker, amount input, time picker
- Substance dropdown defaults to the main substance (falls back to first if none set)
- Recent dose logs list below the log form (all substances, newest first)
- Each entry shows: substance name, amount, time logged
- Delete button on each entry with confirmation dialog
- Tapping an entry opens it for editing

### Milestone 2b: Substance Management Enhancements ← IN PROGRESS
- **Main substance:** `isMain` flag. One substance marked as main — pre-selects in the Log form. Star toggle in Substances screen (selecting a new main unsets the previous one).
- **Visibility toggle:** `isVisible` flag. Hidden substances don't appear in the Log dropdown or dashboard, but their data is preserved. Eye toggle in Substances screen.

### Milestone 3: Per-Substance Fields (Units, Half-Life, Color)
- **Unit field:** Add `unit` column to Substance (e.g., "mg", "ml", "g", "IU"). The dose log stores a raw amount — the unit label comes from the substance. All UI displays the substance's unit instead of hardcoded "mg".
- **Half-life field:** Add `halfLifeHours` column to Substance. Editable in the substance form. Required for the decay calculator.
- **Color field:** Add `color` column (ARGB int). Auto-assigned from a palette when creating a substance, editable by the user. Used for chart lines (Milestone 5) and card accents.
- **Rename `amountMg` → `amount`:** The column name is misleading now that substances have their own units. Migration renames the column.
- Update the substance form, seeder, and all amount displays to use these new fields.

### Milestone 4: Dashboard — Substance Cards & Decay

The dashboard shows one **card per visible substance**. Each card is a self-contained widget showing what's happening with that substance today.

#### 4a: Day Boundary Utility & Decay Calculator
- **Day boundary utility** — Shared function: given a `DateTime`, returns the start of "today" (most recent 5:00 AM). Used by all downstream features.
- **DecayCalculator** — Pure function, unit tested. Takes a list of doses + half-life, returns the active amount at any point in time. Only considers doses within 5 half-lives of the query time.
- **"Total today"** — Sum of all raw amounts for doses logged since the current day boundary.
- **"Current active"** — Decay formula evaluated at `DateTime.now()`.

#### 4b: Substance Card Widget
Each card displays:
- **Title:** Substance name
- **Stats line:** Current active (decayed) / Total consumed today — e.g., "42mg active / 180mg today"
- **Mini graph:** Today's decay curve for this substance only (day boundary → now → projected forward to next day boundary). Small `fl_chart` `LineChart` inside the card.
- **Toolbar** with actions:
  - **Repeat last** — Instantly logs the same substance + amount as the most recent dose. Shows a snackbar with undo. One tap = logged. **Hidden when no previous doses exist.**
  - **Add dose** — Opens the Log form pre-filled with this substance + last dose's amount + current time. The slightly slower path when you want to tweak something before saving.
  - **View log** — Navigates to the substance log screen (see 4c).

#### 4c: Substance Log Screen
A new screen showing the full dose history for a single substance.
- **Lazy-loads 3 days at a time** — starts with the most recent 3 days, loads more as you scroll. Infinite scroll grouped by day (like a social media feed).
- Each day section shows individual dose entries (amount in the substance's unit, time) and a daily total.
- Delete button on each entry with confirmation dialog.
- Tapping an entry opens it for editing.

#### 4d: Performance — Staggered Card Loading
- Load substance cards independently rather than computing all decay curves simultaneously. Each card shows a shimmer/skeleton while its data loads.
- Each card has its own provider, so they resolve independently. Like lazy-loading Inertia components — the shell renders immediately, data fills in per-card.

### Milestone 5: Polish
- Multi-substance combined chart (different colored lines, overlay view)
- Date picker to view historical days on the dashboard

### Milestone 6: Settings & UX Cleanup
- **Rename "Substances" tab to "Settings"** — softer name, leaves room for app-wide settings.
- **Day boundary setting:** Let users configure the hour that defines "start of day" (default 5:00 AM). Stored as a user preference.

### Milestone 7: Persistent Tracking Notification

A sticky notification for "party mode" — pin a substance to your notification shade for rapid logging without opening the app. Like a music player's persistent notification, but for tracking doses.

#### Use case
You're at a party tracking alcohol. You don't want to unlock your phone, open the app, and navigate every time you grab a beer. Pin "Alcohol" to your notifications and tap a button right from the shade.

#### Notification contents
- **Substance name** as the notification title
- **Stats line:** Current active (decayed) / Total consumed today
- **Last logged:** Timestamp of the most recent dose (e.g., "Last: 22:47") — so you can glance and think "did I already log this beer or not?"
- **Repeat last** button — instant one-tap log
- **Add dose** button — opens the app directly to the log form, pre-filled

#### How it works
- Activated from the dashboard card toolbar (pin icon) or from the substance log screen
- Uses Android foreground service + persistent notification (won't get swiped away accidentally)
- Notification updates in real-time as decay values change and when new doses are logged
- Only one substance pinned at a time
- Dismissing the notification or tapping a "stop" button ends the session
- On iOS: likely a Live Activity on the lock screen (platform-specific implementation TBD)

### Milestone 8: Taper Plans

The app's namesake feature. Attach a **taper plan** to a substance to gradually reduce intake over time — e.g., cut caffeine from 400mg/day down to 100mg/day over 6 weeks.

#### Data Model — TaperPlan
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `substanceId` | `int` | FK → substances. One active plan per substance at a time. |
| `startAmount` | `double` | Daily target at the beginning (e.g., 400mg) |
| `targetAmount` | `double` | Daily target at the end (e.g., 100mg) |
| `startDate` | `DateTime` | When the taper begins |
| `endDate` | `DateTime` | When the taper should reach the target |
| `isActive` | `bool` | Only one plan per substance can be active |

#### Linear Taper Calculation
```
daily_target(date) = startAmount + (targetAmount - startAmount) × (days_elapsed / total_days)
```
Simple linear interpolation. On day 0 the target is `startAmount`, on the final day it's `targetAmount`. Before `startDate`, no target applies. After `endDate`, the target stays at `targetAmount`.

#### Dashboard Card Integration
When a substance has an active taper plan, the dashboard card reflects it:
- **Target line on the mini graph** — A horizontal (or gently sloping) line showing today's allowed amount. The actual consumption curve sits below or above it, making it immediately obvious if you're on track.
- **Stats line update** — e.g., "42mg active / 180mg of 350mg today" — showing consumed vs. the day's target.
- **Over-target indicator** — Visual cue (color change, warning icon) when today's total exceeds the target. Not a hard block — you can still log, but the card makes it clear you've gone over.

#### Taper Plan Management
- **Create/edit** from the substance log screen or substance settings — pick start/end dates and amounts.
- **Only one active plan per substance** — starting a new plan deactivates the previous one (with confirmation). Old plans are kept for history.
- **Delete** with confirmation dialog.

#### Progress Chart
A dedicated screen (accessible from the substance card or log screen) showing the taper's progress over its full duration:
- **X-axis:** Date range from `startDate` to `endDate`
- **Target line:** The linear taper — a straight diagonal from `startAmount` down to `targetAmount`
- **Actual consumption:** Daily totals plotted as bars or points, one per day
- **Today marker:** Vertical line or highlight showing where you are in the plan
- Clear visual of days you were on/under/over target. Good days vs. bad days at a glance.

### Milestone 9: Data Export & Backup

Two export features for different use cases, accessible from the Settings screen.

#### SQLite Backup (full backup/restore)
- **Export:** Copy the raw `.db` file to the system share sheet (save to Files, send via AirDrop/email, upload to Drive — whatever the OS offers). The file contains everything: substances, dose logs, taper plans, settings.
- **Import:** Pick a `.db` file, replace the current database, restart the app. All-or-nothing restore. Drift's migration system handles schema version differences (e.g., restoring an older backup into a newer app version).
- This is the "I got a new phone" or "I want a safety net" workflow.

#### CSV Export (data portability)
- Export substances and dose logs as CSV files (one per table, or a single zip). Human-readable, openable in Excel/Google Sheets, useful for analysis or sharing with a doctor.
- **Export only** — no CSV import. Reconstructing foreign keys and validating data from CSV is a lot of code for a feature nobody will use. If you need to restore, use the SQLite backup.

---

## Parked Ideas

Ideas that are good but not scheduled yet. Revisit when the core milestones are done.

- **Substance presets/templates:** When adding a new substance, offer a "pick from template" option with common substances and their half-lives pre-filled (caffeine ~5h, alcohol ~4h, nicotine ~2h, etc.). Good candidate for a first-run wizard if the app ever gets other users.
- **Home screen widget:** Glanceable current levels without opening the app. Complements the notification (Milestone 7) for a less intrusive always-visible option.
- **Non-linear taper curves:** Step-down schedules (reduce by X every N days), exponential curves, or custom schedules. Builds on the linear taper in Milestone 8.
- **Interaction warnings:** Flag when two active substances have known interactions (e.g., caffeine + certain medications). Requires a data source for interactions.
