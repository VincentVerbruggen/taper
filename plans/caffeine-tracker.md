# Taper — Trackable Tracker Roadmap

## What We're Building

A trackable tracker app. You add trackables (like caffeine, alcohol), log doses (e.g., 90mg coffee, 330ml beer), and see a **pharmacokinetic decay curve** showing how much is still active in your system throughout the day.

## Architecture

**Flutter + Riverpod + Drift** — a reactive architecture where the database emits streams, providers transform them, and widgets rebuild automatically.

| Layer | Flutter | Laravel equivalent |
|-------|---------|-------------------|
| UI (Widgets) | `StatelessWidget` / `ConsumerWidget` | Blade templates / Vue components |
| State Management | Riverpod `StreamProvider` / `FutureProvider` | Controller (reactive, like Inertia props) |
| Database | Drift tables + query methods on `AppDatabase` | Eloquent models + query scopes |
| Models | Drift-generated `DataClass` (e.g., `Trackable`) | Eloquent Model attributes |
| DI | Riverpod `Provider` (auto-scoped) | `AppServiceProvider` bindings |

No separate repository or DAO layer — Drift query methods live directly on `AppDatabase`, and Riverpod providers wrap them. Simpler than the old Kotlin MVVM setup.

## Project Structure

```
lib/
├── main.dart                              # App entry point, ProviderScope, MaterialApp
├── data/
│   ├── database.dart                      # Drift tables, AppDatabase, all query methods
│   ├── database.g.dart                    # Generated by build_runner (never edit manually)
│   └── decay_model.dart                   # DecayModel enum (none/exponential/linear)
├── providers/
│   └── database_providers.dart            # Riverpod providers wrapping database streams
├── utils/
│   ├── day_boundary.dart                  # 5 AM day boundary utilities
│   └── decay_calculator.dart              # Pharmacokinetic decay math (exponential + linear)
├── services/
│   └── notification_service.dart          # Persistent notification for rapid dose tracking
└── screens/
    ├── home_screen.dart                   # Bottom nav scaffold (Dashboard / Log / Trackables)
    ├── dashboard_screen.dart              # Dashboard tab (trackable cards + decay curves)
    ├── dashboard/
    │   ├── trackable_log_screen.dart      # Per-trackable dose history (infinite scroll)
    │   └── widgets/
    │       ├── trackable_card.dart        # Card: stats + chart + toolbar
    │       └── decay_curve_chart.dart     # Mini fl_chart LineChart
    ├── log/
    │   ├── log_dose_screen.dart           # Recent doses list + FAB to add
    │   ├── add_dose_screen.dart           # Full form: trackable picker, amount, time
    │   ├── edit_dose_screen.dart          # Edit existing dose log
    │   └── widgets/
    │       └── time_picker.dart           # Reusable time picker widget
    ├── shared/
    │   └── quick_add_dose_dialog.dart     # Quick-add dialog (from dashboard cards)
    └── trackables/
        ├── trackables_screen.dart         # Trackable list with reorder, pin
        ├── add_trackable_screen.dart      # Full form: name, unit, decay model, params
        └── edit_trackable_screen.dart     # Edit form + visibility toggle + delete
```

## Dependencies

| Package | Purpose |
|---------|---------|
| flutter_riverpod | State management (like a reactive service container) |
| drift + drift_flutter | Type-safe SQLite ORM (like Eloquent, with code generation) |
| fl_chart | Charting library for decay curves |
| path_provider + path | Locating the SQLite database file on disk |
| flutter_local_notifications | Persistent notification for rapid dose tracking |

Dev: `drift_dev` + `build_runner` for code generation.

## Data Models (schema v6)

### Trackable
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `name` | `String` | e.g., "Caffeine", "Alcohol" |
| `halfLifeHours` | `double?` | Nullable. For exponential decay (e.g., 5.0 for caffeine) |
| `unit` | `String` | e.g., "mg", "ml", "g", "IU" — displayed in all amount fields |
| `isMain` | `bool` | Legacy, no longer used (kept for migration compat) |
| `isVisible` | `bool` | Default `true`. Hidden trackables don't appear in dropdowns/dashboard |
| `color` | `int` | ARGB color value. Auto-assigned from palette, cycles through 10 colors |
| `sortOrder` | `int` | For drag-to-reorder in the trackables list |
| `decayModel` | `String` | `'none'`, `'exponential'`, or `'linear'` |
| `eliminationRate` | `double?` | Nullable. Units-per-hour for linear decay (e.g., 9.0 ml/h for alcohol) |

### DoseLog
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `trackableId` | `int` | FK → trackables (cascade delete) |
| `amount` | `double` | Raw amount in the trackable's unit |
| `loggedAt` | `DateTime` | When the dose was consumed |

## Decay Models

### Exponential (half-life)
```
active_amount(t) = Σ dose × 0.5^(hours_elapsed / half_life)
```
Used for trackables like caffeine. Cutoff at 5 half-lives (~3% remaining). Sampling every 5 minutes for graphing.

### Linear (constant-rate elimination)
```
active_amount(t) = max(0, dose - elimination_rate × hours_elapsed)
```
Used for trackables like alcohol where the liver processes at a constant rate (zero-order kinetics). BAC drops linearly at ~0.015%/hr. Query window: 24 hours.

### None
No decay tracking. Used for trackables like water where you just want to track intake totals.

## Day Boundary

**"Today" starts at 5:00 AM**, not midnight. This lets late-night doses (e.g., alcohol at 1am) count as the previous day. Implemented as a **shared utility function** used everywhere: dashboard stats, mini graphs, trackable log day grouping, notification stats.

The 5am default becomes a user setting in a later milestone.

## Deletion UX

No swipe-to-delete anywhere. All delete actions use a **delete button with a confirmation dialog** ("Are you sure you want to delete this dose?"). Applies to dose logs and trackables alike.

---

## Implementation Milestones

### Milestone 1: Trackable CRUD ✅
- Drift tables + dependencies
- Trackable table + AppDatabase + seeder (inserts "Caffeine" on first run)
- Riverpod providers for trackable streams
- Bottom nav scaffold (Dashboard / Log / Trackables tabs)
- Trackables screen with full CRUD (add, edit, delete with confirmation)

### Milestone 2: Dose Logging ✅
- DoseLog table + query methods
- Log dose screen with recent doses list + FAB to add
- Dedicated AddDoseScreen with trackable picker, amount input, time picker
- Trackable dropdown auto-selects last-used trackable (falls back to first visible)
- Each entry shows: trackable name, amount with unit, time logged
- Delete button on each entry
- Tapping an entry opens EditDoseScreen for editing

### Milestone 3: Per-Trackable Fields ✅
- **Unit field:** `unit` column (e.g., "mg", "ml"). All UI displays the trackable's unit.
- **Half-life field:** `halfLifeHours` column. Editable in the trackable form.
- **Color field:** `color` column (ARGB int). Auto-assigned from a 10-color palette, cycles.
- **Rename `amountMg` → `amount`:** Migration renames the column.
- Updated seeder: Caffeine (mg, 5h, exponential), Water (ml, none), Alcohol (ml, hidden).

### Milestone 4: Dashboard — Trackable Cards & Decay ✅
- **Day boundary utility** — 5 AM boundary, shared everywhere.
- **DecayCalculator** — Pure static methods for exponential decay, unit tested.
- **Trackable cards** — One per visible trackable. Stats line (active/total), mini decay curve, toolbar (repeat last, add dose, view log).
- **Trackable log screen** — Full history for a single trackable, lazy-loads 3 days at a time, grouped by day with daily totals.
- **Staggered loading** — Each card has its own provider, resolves independently.
- **Quick-add dialog** — From dashboard cards for rapid dose logging.

### Milestone 5: Trackable Edit Revamp + Linear Decay ✅
- **DecayModel enum** (`none`/`exponential`/`linear`) with DB serialization.
- **Database schema v6** — Added `decayModel` and `eliminationRate` columns. Migration backfills existing data (caffeine→exponential, alcohol→linear at 9 ml/hr).
- **Linear decay math** — `activeLinearDoseAt()`, `totalActiveLinearAt()`, `generateLinearCurve()` in DecayCalculator.
- **3-way decay switching** — Providers, notification service, and UI all branch on DecayModel.
- **EditTrackableScreen revamp** — Decay model dropdown, conditional half-life/elimination-rate fields, visibility SwitchListTile, delete with confirmation dialog.
- **AddTrackableScreen** — Dedicated full screen (replaced bottom sheet) with all fields.
- **AddDoseScreen** — Dedicated full screen (replaced bottom sheet) with trackable picker, amount, time.
- **Simplified trackables list** — Removed star/eye/delete icons (moved to edit screen). Kept color dot, reorder arrows, pin. Subtitle shows decay model info.
- **Log form auto-select** — Uses last-logged trackable instead of `isMain`.
- **Persistent notification updated** — 3-way decay switch in `_update()`.

### Milestone 6: Persistent Tracking Notification ✅
- Sticky notification for "party mode" — pin a trackable from the trackables list.
- Shows trackable name, active amount, total today, last logged time.
- "Repeat last" and "Add dose" action buttons.
- Updates in real-time as decay values change.
- Only one trackable pinned at a time.

### Milestone 7: Polish ← NEXT
- [ ] Swipe-to-delete on dose log entries (with undo snackbar)
- [ ] Swipe-to-delete on trackable log screen entries
- [ ] Date picker on dashboard to view historical days
- [ ] Multi-trackable combined chart (different colored lines, overlay view)
- [ ] Color picker in trackable edit screen (currently auto-assigned only)
- [ ] Improve time picker UX in dose forms
- [ ] Empty state improvements (better onboarding hints)
- [ ] Error handling polish (snackbars for failed saves, network issues)

### Milestone 8: Settings & UX Cleanup
- **Rename "Trackables" tab to "Settings"** — softer name, leaves room for app-wide settings.
- **Day boundary setting:** Let users configure the hour that defines "start of day" (default 5:00 AM). Stored as a user preference.

### Milestone 9: Taper Plans

The app's namesake feature. Attach a **taper plan** to a trackable to gradually reduce intake over time — e.g., cut caffeine from 400mg/day down to 100mg/day over 6 weeks.

#### Data Model — TaperPlan
| Column | Type | Notes |
|--------|------|-------|
| `id` | `int` | Auto-increment PK |
| `trackableId` | `int` | FK → trackables. One active plan per trackable at a time. |
| `startAmount` | `double` | Daily target at the beginning (e.g., 400mg) |
| `targetAmount` | `double` | Daily target at the end (e.g., 100mg) |
| `startDate` | `DateTime` | When the taper begins |
| `endDate` | `DateTime` | When the taper should reach the target |
| `isActive` | `bool` | Only one plan per trackable can be active |

#### Linear Taper Calculation
```
daily_target(date) = startAmount + (targetAmount - startAmount) × (days_elapsed / total_days)
```
Simple linear interpolation. On day 0 the target is `startAmount`, on the final day it's `targetAmount`. Before `startDate`, no target applies. After `endDate`, the target stays at `targetAmount`.

#### Dashboard Card Integration
When a trackable has an active taper plan, the dashboard card reflects it:
- **Target line on the mini graph** — A horizontal (or gently sloping) line showing today's allowed amount. The actual consumption curve sits below or above it, making it immediately obvious if you're on track.
- **Stats line update** — e.g., "42mg active / 180mg of 350mg today" — showing consumed vs. the day's target.
- **Over-target indicator** — Visual cue (color change, warning icon) when today's total exceeds the target. Not a hard block — you can still log, but the card makes it clear you've gone over.

#### Taper Plan Management
- **Create/edit** from the trackable log screen or trackable settings — pick start/end dates and amounts.
- **Only one active plan per trackable** — starting a new plan deactivates the previous one (with confirmation). Old plans are kept for history.
- **Delete** with confirmation dialog.

#### Progress Chart
A dedicated screen (accessible from the trackable card or log screen) showing the taper's progress over its full duration:
- **X-axis:** Date range from `startDate` to `endDate`
- **Target line:** The linear taper — a straight diagonal from `startAmount` down to `targetAmount`
- **Actual consumption:** Daily totals plotted as bars or points, one per day
- **Today marker:** Vertical line or highlight showing where you are in the plan
- Clear visual of days you were on/under/over target. Good days vs. bad days at a glance.

### Milestone 10: Data Export & Backup

Two export features for different use cases, accessible from the Settings screen.

#### SQLite Backup (full backup/restore)
- **Export:** Copy the raw `.db` file to the system share sheet (save to Files, send via AirDrop/email, upload to Drive — whatever the OS offers). The file contains everything: trackables, dose logs, taper plans, settings.
- **Import:** Pick a `.db` file, replace the current database, restart the app. All-or-nothing restore. Drift's migration system handles schema version differences (e.g., restoring an older backup into a newer app version).
- This is the "I got a new phone" or "I want a safety net" workflow.

#### CSV Export (data portability)
- Export trackables and dose logs as CSV files (one per table, or a single zip). Human-readable, openable in Excel/Google Sheets, useful for analysis or sharing with a doctor.
- **Export only** — no CSV import. Reconstructing foreign keys and validating data from CSV is a lot of code for a feature nobody will use. If you need to restore, use the SQLite backup.

---

## Parked Ideas

Ideas that are good but not scheduled yet. Revisit when the core milestones are done.

- **Trackable presets/templates:** When adding a new trackable, offer a "pick from template" option with common trackables and their half-lives pre-filled (caffeine ~5h, alcohol ~4h, nicotine ~2h, etc.). Good candidate for a first-run wizard if the app ever gets other users.
- **Home screen widget:** Glanceable current levels without opening the app. Complements the notification for a less intrusive always-visible option.
- **Non-linear taper curves:** Step-down schedules (reduce by X every N days), exponential curves, or custom schedules. Builds on the linear taper in Milestone 9.
- **Interaction warnings:** Flag when two active trackables have known interactions (e.g., caffeine + certain medications). Requires a data source for interactions.
- **Planned consumption days:** From the trackable log screen (grouped by day), copy a day's consumption pattern as a "plan" for tomorrow. E.g., you drank 5 coffees today at 8am, 10am, 12pm, 2pm, 4pm — tap "copy as plan" and those become scheduled doses for tomorrow. Then manually tweak amounts or timings to inch closer to your taper target. Ties into Milestone 9 (taper plans) — instead of just a daily total target, you get a concrete dose-by-dose schedule to follow. Think of it like duplicating a row in a spreadsheet and editing the copy.
- **Quick-add presets per trackable:** Define named shortcuts for common doses — e.g., "Office coffee" = 90mg, "Home coffee" = 120mg, "Glass of wine" = 150ml, "Pint of beer" = 500ml, "Water bottle" = 750ml. Stored as a list on the trackable. These show up as quick-tap buttons on the dashboard card and in the persistent notification, replacing the single "repeat last" with a row of your most common doses. Think of it like saved addresses in a delivery app — one tap instead of typing the same amount every time.
- **Logging reminder vibration:** When the persistent notification is active, the app checks the trackable's `reminderIntervalMinutes` field. If set (e.g., 40 for alcohol) and no dose has been logged within that interval, the phone vibrates as a nudge — "hey, did you forget to log that last drink?" The interval is a property of the trackable (like half-life or unit), so each trackable gets its own sensible default. Null means no reminders. Useful for party mode where you're likely to forget.
