# Milestone 2b: Substance Management Enhancements

## Context
The Log form currently has no default substance — users must pick from the dropdown every time. There's also no way to hide substances you've stopped tracking without deleting them (and losing dose history). This milestone adds two boolean flags to substances: `isMain` (pre-selects in the Log form) and `isVisible` (hides from dropdowns without deleting data).

## Files to Modify

| File | What |
|------|------|
| `lib/data/database.dart` | Add columns, bump schema, migration, new query methods |
| `lib/data/database.g.dart` | Regenerated by build_runner (not manual) |
| `lib/providers/database_providers.dart` | Add `visibleSubstancesProvider` |
| `lib/screens/substances/substances_screen.dart` | Star + eye icons on each substance |
| `lib/screens/log/log_dose_screen.dart` | Filter to visible substances, auto-select main |
| `test/log_dose_screen_test.dart` | Update/add tests for new behavior |

## Implementation Steps

### Step 1: Add columns to Substances table
In `database.dart`, add two `BoolColumn` definitions:

```dart
class Substances extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text()();
  BoolColumn get isMain => boolean().withDefault(const Constant(false))();
  BoolColumn get isVisible => boolean().withDefault(const Constant(true))();
}
```

`withDefault` makes both columns optional in `SubstancesCompanion.insert()` — existing `insertSubstance(name)` calls keep working. Like `$table->boolean('is_main')->default(false)` in a Laravel migration.

### Step 2: Database migration v2 → v3
Bump `schemaVersion` to 3. Add migration block using Drift's `m.addColumn()` — it generates `ALTER TABLE substances ADD COLUMN is_main INTEGER NOT NULL DEFAULT 0`. Update the seeder to seed three substances on fresh install.

### Step 3: New database methods
1. **`watchVisibleSubstances()`** — `Stream<List<Substance>>` filtered to `isVisible == true`, sorted by name.
2. **`setMainSubstance(int id)`** — Transaction: unset all `isMain` flags, then set the target.
3. **`toggleSubstanceVisibility(int id, bool isVisible)`** — Sets `isVisible` on one substance. When hiding, also clears `isMain`.

### Step 4: Add `visibleSubstancesProvider`
New `StreamProvider` that calls `watchVisibleSubstances()`.

### Step 5: Run code generation

### Step 6: Substances screen — star + eye icons
Star icon (filled/outlined) for main, eye icon (open/closed) for visibility, strikethrough when hidden.

### Step 7: Log dose screen — filter + auto-select
Switch to `visibleSubstancesProvider`, auto-select main substance.

### Step 8: Update tests

## Decay Curve Formula
```
active_amount(t) = Σ dose_mg × 0.5^(hours_elapsed / half_life)
```
